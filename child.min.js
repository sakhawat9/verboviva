document.addEventListener("DOMContentLoaded", function () {

  // Filter click & active class toggle
  document.querySelectorAll(".activity-filters").forEach((filterContainer) => {
    const taxonomy = filterContainer.dataset.taxonomy;
    const instance = filterContainer.dataset.instance;

    filterContainer.addEventListener("click", function (e) {
      if (e.target.classList.contains("filter-btn")) {
        // Toggle active class
        filterContainer.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.remove("active");
        });
        e.target.classList.add("active");

        const termId = e.target.dataset.term;
        const slug = e.target.dataset.slug;

        // Update URL
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set(taxonomy, slug);
        window.history.pushState({}, "", newUrl.toString());

        // Ajax fetch
        const resultsContainer = document.querySelector(
          `#styled-activity-results-${instance}`
        );

        const data = new FormData();
        data.append("action", "styled_filter_activities");
        data.append("term_id", termId);
        data.append("taxonomy", taxonomy);
        data.append("posts_per_page", 3);
        data.append("instance", instance);
        data.append("_ajax_nonce", activities_ajax_object.nonce);

        fetch(activities_ajax_object.ajaxurl, {
          method: "POST",
          body: data,
        })
          .then((res) => res.text())
          .then((html) => {
            resultsContainer.innerHTML = html;
          });
      }
    });

    // Handle initial selection from query string
    const urlParams = new URLSearchParams(window.location.search);
    const selectedSlug = urlParams.get(taxonomy);
    if (selectedSlug) {
      const matchingBtn = filterContainer.querySelector(
        `.filter-btn[data-slug="${selectedSlug}"]`
      );
      if (matchingBtn) {
        matchingBtn.click();

        // Scroll to section
        const section = document.getElementById("activities-section-" + instance);
        if (section) {
          const yOffset = -200;
          const y = section.getBoundingClientRect().top + window.pageYOffset + yOffset;
          window.scrollTo({ top: y, behavior: "smooth" });
        }
      }
    }
  });
});

// Pagination handler (jQuery for compatibility with existing setup)
jQuery(document).ready(function ($) {
  function loadActivities(page, instance) {
    const $section = $("#activities-section-" + instance);
    const taxonomy = $section.data("taxonomy") || "";
    const termId = $section.data("term") || 0;
    const postsPerPage = $section.data("posts-per-page") || 6;

    $.post(
      activities_ajax_object.ajaxurl,
      {
        action: "styled_filter_activities",
        taxonomy: taxonomy,
        term_id: termId,
        posts_per_page: postsPerPage,
        instance: instance,
        pagination: true,
        page: page,
        _ajax_nonce: activities_ajax_object.nonce,
      },
      function (response) {
        $("#styled-activity-results-" + instance).html(response);
      }
    );
  }

  $(document).on("click", ".pagination-btn", function () {
    const instance = $(this).closest(".styled-pagination").data("instance");
    const page = $(this).data("page");
    loadActivities(page, instance);
  });
});